<!DOCTYPE html>
<html>

    <head>
        <title> MOSN 源码分析 - 共享内存模型 &middot; trainyao.github.io </title>

        <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.82.0" />




<script src="https://code.jquery.com/jquery-3.1.1.min.js"   integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="   crossorigin="anonymous"></script>


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">


<link rel="stylesheet" href="https://trainyao.github.io/css/nix.css">





<link href="https://fonts.googleapis.com/css?family=Inconsolata%7COpen+Sans%7CConcert+One" rel="stylesheet">






    </head>

    <body>
        <header>
<nav class="navbar navbar-default navbar-fixed-top navbar-inverse font-header">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse-1" aria-expanded="false">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
      <a class="navbar-brand" id="green-terminal" href='https://trainyao.github.io/'>
        trainyao@home ~ $
      </a>
		</div>

		
		<div class="collapse navbar-collapse" id="navbar-collapse-1">
			<ul class="nav navbar-nav navbar-right">
				<li>
					<a href='https://trainyao.github.io/'>/home/trainyao</a>
        </li>
        
				
				
				<li class="dropdown">
                    
            		<a href="https://trainyao.github.io/post/">~/all</a>
            		
        		</li>
        		
				
				<li class="dropdown">
                    
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">category <span class="caret"></span></a>
                    <ul class="dropdown-menu">
                        
                    		<li>
                    		<a href="https://trainyao.github.io/categories/kubernetes/">~/kubernetes</a>
				    		</li>
                		
                    		<li>
                    		<a href="https://trainyao.github.io/categories/devops/">~/devops</a>
				    		</li>
                		
                    		<li>
                    		<a href="https://trainyao.github.io/categories/istio/">~/service mesh/istio</a>
				    		</li>
                		
                    		<li>
                    		<a href="https://trainyao.github.io/categories/gloo/">~/service mesh/envoy/gloo</a>
				    		</li>
                		
                    		<li>
                    		<a href="https://trainyao.github.io/categories/mosn/">~/service mesh/mosn</a>
				    		</li>
                		
                    		<li>
                    		<a href="https://trainyao.github.io/categories/skynet/">~/skynet</a>
				    		</li>
                		
                    		<li>
                    		<a href="https://trainyao.github.io/categories/%E8%84%91%E6%B4%9E/">~/脑洞</a>
				    		</li>
                		
                    		<li>
                    		<a href="https://trainyao.github.io/categories/%E5%85%B6%E4%BB%96/">~/其他</a>
				    		</li>
                		
                    		<li>
                    		<a href="https://trainyao.github.io/categories/%E7%BF%BB%E8%AF%91/">~/翻译</a>
				    		</li>
                		
                    		<li>
                    		<a href="https://trainyao.github.io/categories/kubernetes-%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97/">~/读书笔记/kubernetes 权威指南</a>
				    		</li>
                		
                    		<li>
                    		<a href="https://trainyao.github.io/categories/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/">~/读书笔记/深入理解计算机系统</a>
				    		</li>
                		
            		</ul>
            		
        		</li>
        		

			</ul>
		</div>
	</div>
</nav>
</header>

        <div class="flex-wrapper">
            <div class="container wrapper">
                <h1><a href="https://trainyao.github.io/post/mosn/source_shm/">MOSN 源码分析 - 共享内存模型</a></h1>
                <span class="post-date">2020-02-23 </span>
                <div class="post-content">
                    <p>本文记录了对 MOSN 的源码研究 - MOSN 的共享内存模型。</p>
<p>本文的内容基于 MOSN v0.9.0，commit id <a href="https://github.com/mosn/mosn/tree/b2a239f5">b2a239f5</a>。</p>
<h2 id="机制">机制</h2>
<p>MOSN 用共享内存来存储 metrics 信息。MOSN 用 mmap 将文件映射到内存，在内存数组之上封装了一层关于 metrics 的存取逻辑，实现了 <a href="https://github.com/rcrowley/go-metrics">go-metrics</a>
包的关于 metrics 的接口，通过这种方式组装出了一种基于共享内存的 metrics 实现供 MOSN 使用。</p>
<h2 id="创建共享内存mmap">创建共享内存：Mmap</h2>
<p>操作共享内存的方法主要在 <code>pkg/shm/shm.go</code> 文件下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Alloc</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">size</span> <span style="color:#66d9ef">int</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">ShmSpan</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#f92672">...</span>
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">NewShmSpan</span>(<span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">data</span>), <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Free</span>(<span style="color:#a6e22e">span</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ShmSpan</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">Clear</span>(<span style="color:#a6e22e">span</span>.<span style="color:#a6e22e">name</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">Munmap</span>(<span style="color:#a6e22e">span</span>.<span style="color:#a6e22e">origin</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Clear</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Remove</span>(<span style="color:#a6e22e">path</span>(<span style="color:#a6e22e">name</span>))
}
</code></pre></div><p>都是围绕着 <code>ShmSpan</code> 结构体的几个操作方法。再来看 <code>ShmSpan</code> 结构体：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ShmSpan</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">origin</span> []<span style="color:#66d9ef">byte</span> <span style="color:#75715e">// mmap 返回的数组
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">name</span>   <span style="color:#66d9ef">string</span> <span style="color:#75715e">// span 名, 创建时指定
</span><span style="color:#75715e"></span>
	<span style="color:#a6e22e">data</span>   <span style="color:#66d9ef">uintptr</span> <span style="color:#75715e">// 保存 mmap 内存段的首指针
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">offset</span> <span style="color:#66d9ef">int</span> <span style="color:#75715e">// span 已经使用的字节长度
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">size</span>   <span style="color:#66d9ef">int</span> <span style="color:#75715e">// span 大小
</span><span style="color:#75715e"></span>}
</code></pre></div><p><code>Alloc</code> 方法按照给定的 <code>name</code> 参数，在配置文件的目录下创建文件，并执行 <code>sync.Mmap</code>，其文件尺寸即 <code>size</code> 参数大小。Mmap 过后，将信息保存在 ShmSpan结构内返回。</p>
<p>代码逻辑比较简单，大家可以自行阅读：<a href="https://github.com/mosn/mosn/blob/b2a239f5/pkg/shm/shm.go#L28">https://github.com/mosn/mosn/blob/b2a239f5/pkg/shm/shm.go#L28</a></p>
<p>由此看出，一个 ShmSpan 可以看做是一个共享内存块。</p>
<p>下面我们将会分析共享内存块在 MOSN 里的使用场景：metrics。</p>
<h2 id="操作共享内存配置">操作共享内存：配置</h2>
<p>在分析如何通过共享内存存取 metrics 之前，首先看这相关的功能是如何配置的。</p>
<p><a href="https://github.com/mosn/mosn/blob/b2a239f5/pkg/mosn/starter.go#L318">https://github.com/mosn/mosn/blob/b2a239f5/pkg/mosn/starter.go#L318</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">initializeMetrics</span>(<span style="color:#a6e22e">config</span> <span style="color:#a6e22e">v2</span>.<span style="color:#a6e22e">MetricsConfig</span>) {
	<span style="color:#75715e">// init shm zone
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ShmZone</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ShmSize</span> &gt; <span style="color:#ae81ff">0</span> {
		<span style="color:#a6e22e">shm</span>.<span style="color:#a6e22e">InitDefaultMetricsZone</span>(<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ShmZone</span>, int(<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ShmSize</span>), <span style="color:#a6e22e">store</span>.<span style="color:#a6e22e">GetMosnState</span>() <span style="color:#f92672">!=</span> <span style="color:#a6e22e">store</span>.<span style="color:#a6e22e">Active_Reconfiguring</span>)
        <span style="color:#f92672">...</span>

</code></pre></div><p>从这里看出，通过读取配置文件的 <code>ShmZone</code> 和 <code>ShmSize</code> 来初始化共享内存，即配置文件的以下两个字段是控制着共享内存的文件名和大小的：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#960050;background-color:#1e0010">...</span>
  <span style="color:#f92672">&#34;metrics&#34;</span>: {
    <span style="color:#960050;background-color:#1e0010">...</span>
    <span style="color:#f92672">&#34;shm_zone&#34;</span>: <span style="color:#e6db74">&#34;文件名&#34;</span>,
    <span style="color:#f92672">&#34;shm_size&#34;</span>: <span style="color:#e6db74">&#34;共享内存文件大小&#34;</span>
  },
  <span style="color:#960050;background-color:#1e0010">...</span>
}
</code></pre></div><h2 id="操作共享内存metrics">操作共享内存：metrics</h2>
<p>metrics 相关的逻辑在 <code>pkg/metrics</code> 包下。</p>
<p>上文说的 ShmSpan 是保存共享内存信息的结构体，而要理解 MOSN metrics 对共享内存的使用，还要先理解 MOSN 封装的几个结构体：<code>zone</code>、<code>hashSet</code> 和 <code>hashEntry</code>。</p>
<p>这几个结构体与 <code>ShmSpan</code> 的关系大致是这样的：</p>
<p><img src="./shm.png" alt=""></p>
<p><code>ShmSpan</code> 是共享内存块，而 <code>zone</code>、<code>hashSet</code> 和 <code>hashEntry</code> 对 <code>ShmSpan</code> 进行了划分：</p>
<ul>
<li><code>hashSet</code> 封装出了 metrics name 映射到 metrics value 的哈希表</li>
<li><code>hashEntry</code> 是哈希表的值，也是 metrics 值的保存的共享内存空间</li>
<li><code>zone</code> 对 <code>ShmSpan</code> 进行了划分，划分出了一个 <code>int32</code> 值作为互斥锁；一个 <code>int32</code> 值作为 <code>zone</code> 的引用计数；也划分出了一片空间保存 <code>hashSet</code></li>
</ul>
<p>以上步骤做好后，创建一个 metrics 就可以通过创建对应的哈希 key value，拿到对应的共享内存地址，存取 metrics 信息。</p>
<p>下面是源码步骤，大家可以自行跟踪调试：</p>
<p><em><strong>1) 创建 zone：</strong></em></p>
<p><a href="https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/zone.go#L81">https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/zone.go#L81</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">newSharedMetrics</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">size</span> <span style="color:#66d9ef">int</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">zone</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">alignedSize</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">align</span>(<span style="color:#a6e22e">size</span>, <span style="color:#a6e22e">pageSize</span>)

    <span style="color:#75715e">// 申请 ShmSpan
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">span</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">shm</span>.<span style="color:#a6e22e">Alloc</span>(<span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">alignedSize</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#75715e">// 1. mutex and ref
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 从 span 里取 4 个字节做互斥锁
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">mutex</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">span</span>.<span style="color:#a6e22e">Alloc</span>(<span style="color:#ae81ff">4</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

    <span style="color:#75715e">// 从 span 里取 4 个字节做引用计数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ref</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">span</span>.<span style="color:#a6e22e">Alloc</span>(<span style="color:#ae81ff">4</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">zone</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">zone</span>{
		<span style="color:#a6e22e">span</span>:  <span style="color:#a6e22e">span</span>,
		<span style="color:#a6e22e">mutex</span>: (<span style="color:#f92672">*</span><span style="color:#66d9ef">uint32</span>)(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">mutex</span>)),
		<span style="color:#a6e22e">ref</span>:   (<span style="color:#f92672">*</span><span style="color:#66d9ef">uint32</span>)(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#a6e22e">ref</span>)),
	}

	<span style="color:#75715e">// 2. hashSet
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 划分哈希表过程
</span><span style="color:#75715e"></span>
	<span style="color:#75715e">// assuming that 100 entries with 50 slots, so the ratio of occupied memory is
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// entries:slots  = 100 x 128 : 50 x 4 = 64 : 1
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// so assuming slots memory size is N, total allocated memory size is M, then we have:
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// M - 1024 &lt; 65N + 28 &lt;= M
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// 计算 slot 的数量和内存占用大小
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">slotsNum</span> <span style="color:#f92672">:=</span> (<span style="color:#a6e22e">alignedSize</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">28</span>) <span style="color:#f92672">/</span> (<span style="color:#ae81ff">65</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span>)
	<span style="color:#a6e22e">slotsSize</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">slotsNum</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span>
	<span style="color:#75715e">// 计算 entry 数量和内存占用大小
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">entryNum</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">slotsNum</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>
	<span style="color:#a6e22e">entrySize</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">slotsSize</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">64</span>
	
	<span style="color:#75715e">// 哈希表内存大小 = entry 内存占用 + 20 字节 + slot 内存占用大小
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">hashSegSize</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">entrySize</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">20</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">slotsSize</span>
	<span style="color:#a6e22e">hashSegment</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">span</span>.<span style="color:#a6e22e">Alloc</span>(<span style="color:#a6e22e">hashSegSize</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#75715e">// if zones&#39;s ref &gt; 0, no need to initialize hashset&#39;s value
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 初始化哈希表结构
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">set</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newHashSet</span>(<span style="color:#a6e22e">hashSegment</span>, <span style="color:#a6e22e">hashSegSize</span>, <span style="color:#a6e22e">entryNum</span>, <span style="color:#a6e22e">slotsNum</span>, <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">LoadUint32</span>(<span style="color:#a6e22e">zone</span>.<span style="color:#a6e22e">ref</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#a6e22e">zone</span>.<span style="color:#a6e22e">set</span> = <span style="color:#a6e22e">set</span>

	<span style="color:#75715e">// add ref
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">AddUint32</span>(<span style="color:#a6e22e">zone</span>.<span style="color:#a6e22e">ref</span>, <span style="color:#ae81ff">1</span>)

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">zone</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>这里可以大致说一下哈希表初始化的算法：首先 <code>alignedSize</code> 表示 4k 对齐后的 <code>ShmSpan</code> 大小，前 8 个字节被分配为互斥锁和引用计数，
另外 20 个字节被分配为哈希表的 <code>meta</code> 结构体，</p>
<p><a href="https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/hashset.go#L54">https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/hashset.go#L54</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">hashSet</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">entry</span> []<span style="color:#a6e22e">hashEntry</span>
	<span style="color:#a6e22e">meta</span>  <span style="color:#f92672">*</span><span style="color:#a6e22e">meta</span>
	<span style="color:#a6e22e">slots</span> []<span style="color:#66d9ef">uint32</span>
}

<span style="color:#f92672">...</span>


<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">meta</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">cap</span>       <span style="color:#66d9ef">uint32</span>
	<span style="color:#a6e22e">size</span>      <span style="color:#66d9ef">uint32</span>
	<span style="color:#a6e22e">freeIndex</span> <span style="color:#66d9ef">uint32</span>

	<span style="color:#a6e22e">slotsNum</span> <span style="color:#66d9ef">uint32</span>
	<span style="color:#a6e22e">bytesNum</span> <span style="color:#66d9ef">uint32</span>
}

</code></pre></div><p>所以真正能被分配为哈希表信息储存的空间 = 总空间 - 8 字节 - 20 字节。那能分配多少个哈希表信息呢？要看看 MOSN 的哈希表组织形式：<code>entry</code> 最开始首尾相连，后面会被组织成一个一个的 slot 链表供哈希碰撞时遍历查询。
所以 slot 和 entry 的比例控制着哈希表查找的性能：entry 比 slot 作为比例的话，比例<strong>越高</strong>意味着更容易碰撞，链表越长，查找性能下降；相反比例<strong>越低</strong>链表越短，查找性能越高，但是有越多 slot 闲置，空间会浪费。</p>
<p>从注释看，MOSN 将比例写死为 <code>2：1</code>。假设 <code>100 个 entry + 50 个 slot</code>，其内存比等于 <code>100 * 128（entry 内存占用）：50 * 4</code> = <code>64：1</code>，即一份 <code>2：1</code> 的 entry+slot 需要用到<code>（64 + 1）* 4</code> 个字节。</p>
<p>所以，如果按照 2：1 来分配的话，一共可以分配的份数 = <code>哈希表信息储存空间 / 每一份空间占用 = (总空间 - 8 - 20) / (64 + 1) * 4</code> 份。由此就可以算出 entry 和 slot 可以分配多少份了。</p>
<p><em><strong>2) 创建指标：</strong></em></p>
<p><a href="https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/counter.go#L56">https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/counter.go#L56</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewShmCounterFunc</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">func</span>() <span style="color:#a6e22e">gometrics</span>.<span style="color:#a6e22e">Counter</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>() <span style="color:#a6e22e">gometrics</span>.<span style="color:#a6e22e">Counter</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">defaultZone</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">entry</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">defaultZone</span>.<span style="color:#a6e22e">alloc</span>(<span style="color:#a6e22e">name</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#f92672">...</span>
</code></pre></div><p><a href="https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/zone.go#L166">https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/zone.go#L166</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">z</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">zone</span>) <span style="color:#a6e22e">alloc</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">hashEntry</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">z</span>.<span style="color:#a6e22e">lock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">z</span>.<span style="color:#a6e22e">unlock</span>()

	<span style="color:#a6e22e">entry</span>, <span style="color:#a6e22e">create</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">z</span>.<span style="color:#a6e22e">set</span>.<span style="color:#a6e22e">Alloc</span>(<span style="color:#a6e22e">name</span>)
	<span style="color:#f92672">...</span>
</code></pre></div><p><a href="https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/hashset.go#L135">https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/hashset.go#L135</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hashSet</span>) <span style="color:#a6e22e">Alloc</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">hashEntry</span>, <span style="color:#66d9ef">bool</span>) {
	<span style="color:#75715e">// 1. search existed slots and entries
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 计算 hash 值作为 slot index
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">h</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">hash</span>(<span style="color:#a6e22e">name</span>)
	<span style="color:#a6e22e">slot</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">h</span> <span style="color:#f92672">%</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">meta</span>.<span style="color:#a6e22e">slotsNum</span>

	<span style="color:#75715e">// name convert if length exceeded
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">name</span>) &gt; <span style="color:#a6e22e">maxNameLength</span> {
		<span style="color:#75715e">// if name is longer than max length, use hash_string as leading character
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// and the remaining maxNameLength - len(hash_string) bytes follows
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">hStr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Itoa</span>(int(<span style="color:#a6e22e">h</span>))
		<span style="color:#a6e22e">name</span> = <span style="color:#a6e22e">hStr</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">name</span>[len(<span style="color:#a6e22e">hStr</span>)<span style="color:#f92672">+</span>len(<span style="color:#a6e22e">name</span>)<span style="color:#f92672">-</span><span style="color:#a6e22e">maxNameLength</span>:]
	}

	<span style="color:#a6e22e">nameBytes</span> <span style="color:#f92672">:=</span> []byte(<span style="color:#a6e22e">name</span>)

    <span style="color:#75715e">// 查找链表找到对应的 entry
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">entry</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">hashEntry</span>
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">index</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">slots</span>[<span style="color:#a6e22e">slot</span>]; <span style="color:#a6e22e">index</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">sentinel</span>; {
		<span style="color:#a6e22e">entry</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">entry</span>[<span style="color:#a6e22e">index</span>]

		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">entry</span>.<span style="color:#a6e22e">equalName</span>(<span style="color:#a6e22e">nameBytes</span>) {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">entry</span>, <span style="color:#66d9ef">false</span>
		}

		<span style="color:#a6e22e">index</span> = <span style="color:#a6e22e">entry</span>.<span style="color:#a6e22e">next</span>
	}

	<span style="color:#75715e">// 2. create new entry
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 如果找不到, 创建新的 entry
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">meta</span>.<span style="color:#a6e22e">size</span> <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">meta</span>.<span style="color:#a6e22e">cap</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">false</span>
	}

    <span style="color:#75715e">// 创建新的 entry 从 hashset 的 meta 信息里拿 next free index
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">newIndex</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">meta</span>.<span style="color:#a6e22e">freeIndex</span>
	<span style="color:#a6e22e">newEntry</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">entry</span>[<span style="color:#a6e22e">newIndex</span>]
	<span style="color:#a6e22e">newEntry</span>.<span style="color:#a6e22e">assignName</span>(<span style="color:#a6e22e">nameBytes</span>)
	<span style="color:#a6e22e">newEntry</span>.<span style="color:#a6e22e">ref</span> = <span style="color:#ae81ff">1</span>

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">entry</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#75715e">// 所以是链表头,保存 index 到 slot
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">slots</span>[<span style="color:#a6e22e">slot</span>] = <span style="color:#a6e22e">newIndex</span>
	} <span style="color:#66d9ef">else</span> {
		<span style="color:#75715e">// 否则保存在上一个 entry 的 next 字段内
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">entry</span>.<span style="color:#a6e22e">next</span> = <span style="color:#a6e22e">newIndex</span>
	}

	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">meta</span>.<span style="color:#a6e22e">size</span><span style="color:#f92672">++</span>
	<span style="color:#75715e">// 设置 next free index
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">meta</span>.<span style="color:#a6e22e">freeIndex</span> = <span style="color:#a6e22e">newEntry</span>.<span style="color:#a6e22e">next</span>
	<span style="color:#75715e">// 设置队尾
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">newEntry</span>.<span style="color:#a6e22e">next</span> = <span style="color:#a6e22e">sentinel</span>

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">newEntry</span>, <span style="color:#66d9ef">true</span>
}
</code></pre></div><p><em><strong>3) 用 Entry 保存 metrics 值</strong></em></p>
<p><a href="https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/counter.go#L56">https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/counter.go#L56</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewShmCounterFunc</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">func</span>() <span style="color:#a6e22e">gometrics</span>.<span style="color:#a6e22e">Counter</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>() <span style="color:#a6e22e">gometrics</span>.<span style="color:#a6e22e">Counter</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">defaultZone</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">entry</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">defaultZone</span>.<span style="color:#a6e22e">alloc</span>(<span style="color:#a6e22e">name</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
			    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ShmCounter</span>(<span style="color:#a6e22e">unsafe</span>.<span style="color:#a6e22e">Pointer</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">entry</span>.<span style="color:#a6e22e">value</span>))
			}
			<span style="color:#f92672">...</span>
</code></pre></div><p>可以看出，entry 的 <code>value</code> 是真正被用作记录 metrics 值的地方，它是一个 64 位的空间。</p>
<h2 id="为什么使用共享内存保存-metrics">为什么使用共享内存保存 metrics</h2>
<p>看到这里你可能会问，为什么要这么辛苦封装共享内存来保存 metrics 值？为什么不直接使用堆空间来做呢？</p>
<p>其实在源码里也有答案：</p>
<p><a href="https://github.com/mosn/mosn/blob/b2a239f5/pkg/mosn/starter.go#L318">https://github.com/mosn/mosn/blob/b2a239f5/pkg/mosn/starter.go#L318</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">initializeMetrics</span>(<span style="color:#a6e22e">config</span> <span style="color:#a6e22e">v2</span>.<span style="color:#a6e22e">MetricsConfig</span>) {
	<span style="color:#75715e">// init shm zone
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ShmZone</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ShmSize</span> &gt; <span style="color:#ae81ff">0</span> {
		<span style="color:#a6e22e">shm</span>.<span style="color:#a6e22e">InitDefaultMetricsZone</span>(<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ShmZone</span>, int(<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ShmSize</span>), <span style="color:#a6e22e">store</span>.<span style="color:#a6e22e">GetMosnState</span>() <span style="color:#f92672">!=</span> <span style="color:#a6e22e">store</span>.<span style="color:#a6e22e">Active_Reconfiguring</span>)
        <span style="color:#f92672">...</span>
</code></pre></div><p><a href="https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/zone.go#L58">https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/zone.go#L58</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">createMetricsZone</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">size</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">clear</span> <span style="color:#66d9ef">bool</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">zone</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">clear</span> {
		<span style="color:#a6e22e">shm</span>.<span style="color:#a6e22e">Clear</span>(<span style="color:#a6e22e">name</span>)
	}
    <span style="color:#f92672">...</span>
</code></pre></div><p>如果 <code>clear</code> 为真，共享内存就会被清除，那么什么时候为假呢？当 <code>store.GetMosnState()</code> 方法返回 <code>store.Active_Reconfigureing</code> 的时候。即，当 MOSN reconfig 重启的时候，
已经保存的 metrics 是会被保留的。</p>
<p>而且从这里可以看出：</p>
<p><a href="https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/zone.go#L124">https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/zone.go#L124</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">newSharedMetrics</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">size</span> <span style="color:#66d9ef">int</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">zone</span>, <span style="color:#66d9ef">error</span>) {
    <span style="color:#f92672">...</span>
	<span style="color:#a6e22e">set</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newHashSet</span>(<span style="color:#a6e22e">hashSegment</span>, <span style="color:#a6e22e">hashSegSize</span>, <span style="color:#a6e22e">entryNum</span>, <span style="color:#a6e22e">slotsNum</span>, <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">LoadUint32</span>(<span style="color:#a6e22e">zone</span>.<span style="color:#a6e22e">ref</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
	<span style="color:#f92672">...</span>
</code></pre></div><p><a href="https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/hashset.go#L78">https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/hashset.go#L78</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">newHashSet</span>(<span style="color:#a6e22e">segment</span> <span style="color:#66d9ef">uintptr</span>, <span style="color:#a6e22e">bytesNum</span>, <span style="color:#a6e22e">cap</span>, <span style="color:#a6e22e">slotsNum</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">init</span> <span style="color:#66d9ef">bool</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">hashSet</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">set</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">hashSet</span>{}
	<span style="color:#f92672">...</span>
</code></pre></div><p>当 <code>zone.ref</code> 引用计数不为 0 的时候，哈希表里面的信息也是会被保留的。</p>
<p>再来看 <code>zone.mutex</code> 互斥锁的使用：</p>
<p><a href="https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/zone.go#L136">https://github.com/mosn/mosn/blob/b2a239f5/pkg/metrics/shm/zone.go#L136</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">z</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">zone</span>) <span style="color:#a6e22e">lock</span>() {
	<span style="color:#a6e22e">times</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>

	<span style="color:#75715e">// 5ms spin interval, 5 times burst
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">CompareAndSwapUint32</span>(<span style="color:#a6e22e">z</span>.<span style="color:#a6e22e">mutex</span>, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">pid</span>) {
			<span style="color:#66d9ef">return</span>
		}
	<span style="color:#f92672">...</span>
</code></pre></div><p>是通过设置进程 ID 来获取锁的，由此能看出 MOSN 的用意：<strong>这个以文件作为 mmap 的共享内存是可以被多个 MOSN 进程共用的</strong>。</p>
<p>例如 MOSN 支持跨容器热重启的场景，基于内存共享的 metrics 可以保证热重启过程中不出现指标抖动而造成监控异常。
而且这个文件可以看作是一种文件格式，在任何时候都可以被持久化保存和提取分析使用的。</p>
<h2 id="总结">总结</h2>
<p>本文通过分析 MOSN 源码，简述了 MOSN 的共享内存模型，分析了 MOSN 创建共享内存、配置 metrics 和 metrics 对共享内存块的使用。</p>
<p>最后，不鼓励在 Go 里面使用共享内存，除非你有明确的使用场景，例如 MOSN 热升级场景下的 metrics 共享。</p>
<hr>
<p>参考资料:</p>
<ul>
<li><a href="https://github.com/mosn/mosn">MOSN 源码</a></li>
</ul>

                </div>
                
                <div class="post-comments">
                    
                </div>
                
            </div>
            <footer class="footer text-center">
<p>Copyright &copy; 2021 Hello, I&#39;m trainyao. -
<span class="credit">
	Powered by
	<a target="_blank" href="https://gohugo.io">Hugo</a>
	and
	<a target="_blank" href="https://github.com/LordMathis/hugo-theme-nix/">Nix</a> theme.
</span>
</p>
</footer>

        </div>
    </body>
