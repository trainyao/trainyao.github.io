<!DOCTYPE html>
<html lang="zh-cn">

	<head>
		<title> Posts &middot; trainyao.github.io </title>

		<meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.48" />


<script   src="https://code.jquery.com/jquery-3.1.1.min.js"   integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="   crossorigin="anonymous"></script>


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">


<link rel="stylesheet" href="https://trainyao.github.io/css/nix.css">


<link href="https://fonts.googleapis.com/css?family=Inconsolata%7COpen+Sans%7CConcert+One" rel="stylesheet">




	</head>

	<body>
		<header>
<nav class="navbar navbar-default navbar-fixed-top navbar-inverse font-header">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse-1" aria-expanded="false">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" id="green-terminal" href=https://trainyao.github.io/>trainyao@home ~ $</a>
		</div>

		
		<div class="collapse navbar-collapse" id="navbar-collapse-1">
			<ul class="nav navbar-nav navbar-right">
				<li>
					<a href="https://trainyao.github.io/">/home/trainyao</a>
				</li>
				
				
				<li class="dropdown">
                    
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">读书笔记 <span class="caret"></span></a>
                    <ul class="dropdown-menu">
                        
                    		<li>
                    		<a href="/post/bookread/computer_system">~/读书笔记/深入理解计算机系统</a>
				    		</li>
                		
            		</ul>
            		
        		</li>
        		

			</ul>
		</div>
	</div>
</nav>
</header>

		<div class="container wrapper">
			<div class="row">
				<div class="col-xs-12 text-center">
					<h1 id=>Posts</h1>
				</div>
			</div>
			<ul id="post-list">
                	
				<li>
					<div class="post-list-item">
						<div class="post-header">
							<h4 class="post-link"><a href="https://trainyao.github.io/post/skynet/timer/"></a></h4>
							<h4 class="post-date">Jan 1, 0001</h4>
						</div>
						<div class="post-summary"><p>skynet里的定时器 这周花了点时间看了skynet关于定时器功能的源码,以及扩展的了解了一下定时器实现的其他方案,写一遍博客总结一下.内容会分为下面几部分:
 skynet的定时器结构图 skynet定时器执行过程 关于skynet定时器的一些思考 其他定时器方案 linux定时器方案 总结  1. skynet的定时器结构图 2. skynet定时器执行过程 首先确定定时器里面的几个概念:
 tick: 指skynet timer线程每一次处理事件的循环.由于这个循环每隔0.00025秒会执行一次,很像时钟滴答滴答的走,很多书籍都称为tick skynet启动时间戳: 顾名思义,比如1528613417时间戳(北京时间2018/6/10 14:50:17)代表skynet是这个时间点启动的,而且这个时间是不会变的.这个比较容易理解 系统启动时间数: 单位0.01秒. 顾名思义,但是为什么说是时间数呢?因为这是一个时间的量,比如300,表示系统启动了3秒.skynet timer线程在每一次tick都会去同步这个时间量 skynet启动时间数: 单位0.01秒. 与系统启动时间数类似,如300,表示skynet启动了3秒,每次tick skynet timer线程也会去更新这个时间量  首先需要说明的是,skynet定时器的时间刻度是百分秒(0.01秒).意味着skynet最小可以定义事件0.01秒后执行.这个精度对于游戏领域可以说是够用了.
skynet初始化时会创建5个定时器的事件槽,分别是Near,level0-3.每个定时器事件是按照触发时间(这个触发时间是以skynet启动时间数作为参照的.比如触发时间为300,事件注册时skynet创建时间量为100,表示注册这个事件在2秒后执行)为索引插入到对应的槽里面的.用索引的方式安排这些事件保证了查询和插入的性能( 时间复杂度为O(1) ).
那skynet是怎么安排这些事件应该放入哪个槽呢? 5个不同的槽又是什么关系呢?
skynet根据触发时间得出事件应该插入到哪个槽,哪个索引.触发时间是一个32位的整型值.skynet将这32位分为 6 6 6 6 8位每个区间.如果前24位有值,表示这个事件是比较延后触发的,skynet将它们安排到level槽里面,表示这些事件暂时不关注,高0-6位有值的插入到level 3槽里,高7-12位有值的插入到level 2槽里,如此类推,高19-24位有值的,插入到level 0槽里.而高24位没有值,低8位有值的事件,skynet认为是需要比较关注的事件,并以低8位为索引插入到Near(near可能就是比较近会发生的事件的意思)槽里.具体插入后的结果就像上面图中画的一样.
skynet timer的每次tick,都会以系统时间为参照,检查这次tick落后了系统时间多少百分秒,然后将落后的系统时间同步回skynet启动时间数里,并执行这个时间数低8位为索引的Near槽里的事件.
你可能会有一个疑惑,假如我注册了一个0x01 01为触发时间的事件A(这个事件应该被插入到Level 0[0x01]槽里),还有一个0xff为触发时间的事件B(这个事件应该被插入到Near[0xff]槽里),当时间走到0xff时,时间B会被顺利执行.但是当时间走到0x01 01时,时间A怎么办?它会被怎么执行?
skynet在每个高24有值的&quot;整点&quot;,都会将对应的Level槽里的事件整理到Near槽里,然后执行.高24位有值的整点指0x0f00 0x0100 0x1000 0000这些时间点.如上面的例子,当时间走到0x0100的时候,skynet会将Level 0[0x01(0x0101 的低15-9位是0x01)]槽里的事件整理到Near槽里,即将事件B插入到Near[0x01(0x0101 的低8-0位是0x01)]槽里.时间再走1个百分秒,timer线程就会执行Near[0x01]槽里的事件,就会将事件B处理掉了.
这也是为什么上图在Near[0xf0]里会有事件的触发时间是0xf0,也有的是0x0f f0,0x0f f0的事件是timer线程从Level 0槽里整理过去的.只不过,上图有一点不对的是,0xf0和0x0f f0时间不可能同时存在在Near[0xf0]里面,这里只是为了说明Near槽里面有可能出现的事件,忽略细节.而Level 0槽里,一个索引的列表会有低8位有各种值的事件包含在里面,等到timer线程走到整点的时候,再被处理整理到Near槽里面去.
上面就是skynet定时器整个工作的过程.用索引的方式保证了插入和查询的高效,而分槽的方式保证了触发事件的高效,着急的事件重点关注,不着急的事件延后处理.而按66668位每个区间来划分和注册事件,使用位操作作为哈希算法提升了插入和查找的性能.
3. 关于skynet定时器的一些思考  timer线程在处理Near槽一个索引的事件队列时,如果同时有事件插入到这个槽里,会发生什么呢?</p></div>
						<div class="post-list-footer text-center">
							<a href="https://trainyao.github.io/post/skynet/timer/">Read More</a>
						</div>
					</div>
				</li>
			
				<li>
					<div class="post-list-item">
						<div class="post-header">
							<h4 class="post-link"><a href="https://trainyao.github.io/post/thoughts/lockmash/"></a></h4>
							<h4 class="post-date">Jan 1, 0001</h4>
						</div>
						<div class="post-summary"><p> Lock mesh  想法  前些天在研究分布式锁的方案，突发奇想，在云原生时代，像 php、c、go、java 这种原来用特定编程语言开发的程序，已经通过打包、编排，变成了云原生操作系统里的一个工作进程。而像是网络这种原本的操作系统基础设施，也在云原生操作系统里面有了实现（从微服务发展到 service mesh）。
那么，锁是不是也可以看作是基础设施，提供给云原生操作系统的工作进程使用呢？
云原生开发者在编写工作进程逻辑的时候，无需考虑引入哪个分布式锁的包/库，就像是调用系统调用一样，将资源锁住，读写资源，然后再调用系统调用进行解锁。而云原生操作系统负责调度容器进行资源的访问，防止容器争抢资源。这样做的好处是，可以屏蔽掉不同语言的分布式锁之间的实现差异，让业务逻辑开发者专注业务逻辑的优化、思考业务应该使用哪种锁，以及锁的粒度等业务相关的工作。
其实不止是锁，也许还可以思考一下，原生操作系统的基础设施有哪些可以对应到云原生操作系统上的。
且不论叫它 lock mesh 是否合理吧：）
有这个想法后，我在 github、google 和 CNCF landscape 上搜索了一番，没有找到相关的项目或者资料。后续我会再进行一些搜索，确定我是不是想别人已经想到的东西。
如果你也觉得这个想法可行，不妨跟我联系哦：）
 怎么办  有了想法，然后呢？
我列了一些 todo 项：
 再搜索一下是否已经存在相关的资料、项目 思考这个方案是否有必要，是否可行  有没有必要做这一层抽象，编写容器逻辑的开发者，其实是不是按照原来的方式，调用库就好了 如果要做，怎么基于云原生平台（像是 kubernetes）去实现这种基础设施  如果可行，根据具体方案，给出架构图 立项，做项目规划 写demo 开源出去，让更多的开发者接触到项目，并参与代码贡献 建立社区，完善文档（微信群、钉钉群（国内）、slack（国外））  </p></div>
						<div class="post-list-footer text-center">
							<a href="https://trainyao.github.io/post/thoughts/lockmash/">Read More</a>
						</div>
					</div>
				</li>
			
			</ul>
            

<div class="pagination-wrapper text-center">
  <ul class="pagination">
      
      <li>
          <a href="/post/" aria-label="First"><span aria-hidden="true">&laquo;&laquo;</span></a>
      </li>
      
      <li
      >
          <a href="/post/" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>
      </li>
      
      <li
      ><a href="/post/">1</a></li>
      
      <li
      class="active"><a href="/post/page/2/">2</a></li>
      
      <li
      class="disabled">
          <a href="" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>
      </li>
      
      <li>
          <a href="/post/page/2/" aria-label="Last"><span aria-hidden="true">&raquo;&raquo;</span></a>
      </li>
      
    </ul>
</div>



			<div class="push"></div>
		</div>
		<footer class="footer text-center">
<p>Copyright &copy; 2018 Hello, I&#39;m trainyao. -
<span class="credit">
	Powered by
	<a target="_blank" href="https://gohugo.io">Hugo</a>
	and
	<a target="_blank" href="https://github.com/LordMathis/hugo-theme-nix/">Nix</a> theme.
</span>
</p>
</footer>

	</body>
</html>
