<!DOCTYPE html>
<html>

    <head>
        <title>  &middot; trainyao.github.io </title>

        <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.40.1" />


<script   src="https://code.jquery.com/jquery-3.1.1.min.js"   integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="   crossorigin="anonymous"></script>


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">


<link rel="stylesheet" href="https://trainyao.github.io/css/nix.css">


<link href="https://fonts.googleapis.com/css?family=Inconsolata%7COpen+Sans%7CConcert+One" rel="stylesheet">




    </head>

    <body>
        <header>
<nav class="navbar navbar-default navbar-fixed-top navbar-inverse font-header">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse-1" aria-expanded="false">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" id="green-terminal" href=https://trainyao.github.io/>trainyao@home ~ $</a>
		</div>

		
		<div class="collapse navbar-collapse" id="navbar-collapse-1">
			<ul class="nav navbar-nav navbar-right">
				<li>
					<a href="https://trainyao.github.io/">/home/trainyao</a>
				</li>
				
				
				<li class="dropdown">
                    
            		<a href="/content/post/bookread">~/读书笔记</a>
            		
        		</li>
        		

			</ul>
		</div>
	</div>
</nav>
</header>

        <div class="container wrapper">
            <h1><a href="https://trainyao.github.io/post/php/php_extension/overview/"></a></h1>
            <span class="post-date">Jan 1, 0001 </span>
            <div class="post-content">
                <p>@(PHP)
###PHP扩展分享
###什么时候需要写php扩展
* 有需要使用php调用C/C++函数库
* 实现php没有的功能
* 优化php性能</p>

<p>###php扩展简介
php提供一个工具用来生成php扩展的代码,类似代码生成器,工具目录<code>source/to/php_source_code/ext/ext_skel</code>,这个是供类unix平台调用的脚本,php源码也提供了一个供windows平台调用的脚本,用来生成php扩展代码.该脚本是个php脚本,在<code>source/to/php_source_code/ext/ext_skel_win32.php</code></p>

<p>php将扩展代码统一放到<code>source/to/php_source_code/ext/</code>下,这样当开发者按照工具生成对应格式的php扩展源码,并统一放到这个目录下,php源码就会自动识别,并可以选在在编译时加上开发者的扩展.
###先找个题目
总所周知php在连接字符串会进行多次初始化临时变量,和内存复制.假设有一个变态的需求需要重复一个字符串&rsquo;a&rsquo; n次,并且在系统中多次出现,由于n已知,为了提高性能,可以考虑用扩展实现
###动手
####1. 编写扩展原型文件,使用工具生成扩展代码</p>

<p>php没有规定原型文件的<strong>文件后缀</strong>,但有规定原型文件的<strong>格式</strong>.
如果你的扩展需要暴露出接口函数供php代码调用,原型文件只需包含接口函数的原型.接口函数原型包括函数输入参数的类型和名字,还有函数返回的类型.其中类型支持php的变量类型.如bool,int,string,float等等..
根据上面的需求,创建一个名为<code>repeatString</code>的函数,返回类型为<code>string</code>,接受一个<code>string</code>类型的<code>$inputString</code>字符串,和一个<code>int</code>类型的<code>$repeatCount</code>,表示输出<code>$inputString</code>被重复<code>$repeatCount</code>次的字符串.
首先进入ext目录</p>

<pre><code>cd path/to/php_source_code/ext &amp;&amp; \
vim repeatString.proto
</code></pre>

<p>编写内容</p>

<pre><code>string repeatString(string inputString, int repeatCount)
</code></pre>

<p>保存,使用ext_skel工具生成扩展框架,可以指定扩展名和扩展的原型文件</p>

<pre><code>./ext_skel --extname=repeatString --proto=repeatString.proto
</code></pre>

<p>你会看到ext目录下会多了一个<code>repeatString</code>的文件夹,里面放的就是你扩展的所有所需文件
需要留意的有几个文件:</p>

<ul>
<li>config.m4 &ndash; *unix平台下配置文件,这里是官方解释:</li>
</ul>

<blockquote>
<p>扩展的 config.m4 文件告诉 UNIX 构建系统哪些扩展 configure 选项是支持的，你需要哪些扩展库，以及哪些源文件要编译成它的一部分。对所有经常使用的 autoconf 宏，包括 PHP 特定的及 autoconf 内建的，请查看 Zend Engine 2 API 参考 章节。</p>
</blockquote>

<ul>
<li>config.w32 &ndash; windows平台下扩展的配置文件</li>
<li>php_repeatString.h &ndash; 扩展头文件</li>
<li>repeatString.c &ndash; 扩展核心代码c文件</li>
<li>tests &ndash; 单元测试文件
<br /></li>
</ul>

<p>####2. 编写核心代码
进入repeatString.c文件,可以看到这个文件都做了些什么:
* 引用了扩展必要的头文件
* 保证<code>php_repeatString.h</code>头文件内定义的全局变量线程安全
* 定义扩展所需的ini配置变量名
* <strong>实现扩展方法  &ndash; 我们接下来重点关注这个</strong>
* 实现MINIT MSHUTDOWN RINIT RSHUTDOWN 方法
* 定义扩展方法入口 和 扩展初始化方法入口
可以看到我们需要实现的方法<code>PHP_FUNCTION(repeatString)</code>, 它是一个宏,是php提供的一个接口,用来定义php接口函数.我们在里面实现我们需要的逻辑:</p>

<pre><code>PHP_FUNCTION(repeatString)
{
        char *inputString = NULL;
        int argc = ZEND_NUM_ARGS();
        size_t inputString_len;
        zend_long repeatCount;
        if (zend_parse_parameters(argc, &quot;sl&quot;, &amp;inputString, &amp;inputString_len, &amp;count) == FAILURE)
                return;
        char * repeatBuffer = (char *)emalloc(inputString_len * count + 1);
        char * pointer = repeatBuffer;
        while(count--) {
                memcpy(pointer, inputString, inputString_len);
                pointer += inputString_len;
        }
        *pointer = '\0';
        RETURN_STRINGL(repeatBuffer, repeatedLength);
}
</code></pre>

<p>####3. 让php加载扩展</p>

<p>php加载php扩展的方式有2种:
* 作为扩展模块,写进php.ini内,在php启动时加载<code>.so</code>文件
* 在编译php期间加入
我们先用第二种方式实现,首先要让<code>./configure</code>文件找到我们的模块,进入<code>config.m4</code>文件,可以看到这两行代码控制着<code>./configure</code>命令是否能传参<code>--enable-repeatString</code>,从而将我们的扩展编译进php,把注释去掉实现我们的目的</p>

<pre><code>dnl &quot;dnl&quot;表示注释,去掉第一第三行的`&quot;dnl&quot;
dnl PHP_ARG_ENABLE(repeatString, whether to enable repeatString support,
dnl Make sure that the comment is aligned:
dnl [  --enable-repeatString           Enable repeatString support])
</code></pre>

<p>退回到php源码根目录,重新生成配置文件(<code>./buildconf</code>需要安装autoconf)</p>

<pre><code>cd ../../ &amp;&amp; ./buildconf
</code></pre>

<p>由于我用的是git pull下来的仓库,这里会提示git仓库不应该执行<code>./buildconf</code>命令,应该在release包执行,我们加上<code>--force</code>就好</p>

<pre><code>./buildconf --force w
</code></pre>

<p>这个命令将会重新生成<code>./configure</code>命令,输入</p>

<pre><code>./configure --help | grep repeat
</code></pre>

<p>可以看到,我们的扩展已经能被<code>./configure</code>认出来,运行</p>

<pre><code class="language-powershell">./configure --disable-all --enable-repeatString &amp;&amp; make
</code></pre>

<p>重新编译php,接下来就可以测试一下我们的扩展了</p>

<pre><code class="language-php">&lt;?php
$input = 'input';
$count = 3;
var_dump(repeatString($input, $count));
</code></pre>

<p>###说一些细节
####1. php接口函数解析参数
php提供方法<code>zend_parse_parameters</code>对php接口函数期待的参数进行获取,判断类型和初始化.例如在:</p>

<pre><code>if (zend_parse_parameters(argc, &quot;sl&quot;, &amp;inputString, &amp;inputString_len, &amp;count) == FAILURE)
		return;
</code></pre>

<p>中,该方法接受一个<code>argc</code>参数,表示接口函数有几个期待参数;</p>

<p>第二个参数<code>&quot;sl&quot;</code>表示接口函数第一个参数期待<code>string</code>类型,第二个参数期待<code>long int</code>类型,在使用<code>ext_skel</code>生成扩展源码时,我们的原型文件指定了参数的类型,所以这里的<code>&quot;sl&quot;</code>是对应生成的</p>

<p>后面的参数是接口函数的参数的容器,当<code>zend_parse_parameters</code>方法执行完之后,php会将php脚本解析的zend_value变量对应的值传入容器,我们在c代码里面就可以进行使用了.</p>

<p>我们甚至可以在初始化参数时进行判断,来做一些针对不同传参的不同的逻辑.比如传一个字符串一个整形时做些什么,传两个都是字符串类型时又做些什么.</p>

<p>对于<code>&quot;sl&quot;</code>更多类型可以在<a href="http://php.net/manual/zh/internals2.funcs.php">这里</a>看到,或者在PHP源码包的<code>README.PARAMETER_PARSING_API</code>文件内有详尽的描述</p>

<p>####2. php API
可以看到我们在实现<code>repeatString</code>扩展时用到了<code>emalloc</code>方法来分配内存,其实这是一个类似c函数<code>malloc</code>的宏,主要实现了php内存管理.也就是说,用php提供的接口函数去分配内存,不用担心出现内存泄露的问题,在php结束的时候,该部分内存会自动进行释放.这部分是php这个框架帮我们做的</p>

<p>更多的phpAPI方法/宏可以看<a href="http://php.net/manual/zh/internals2.ze1.zendapi.php">这里</a>.</p>

<p>####3. php接口函数返回值
可以看到我们在接口函数结尾返回的时候用了<code>RETURN_STRINGL</code>宏,这也是php提供的一个接口,可以将c变量封装回zend_value返回到php脚本,或者说php执行环境中.</p>

<p>####4. 扩展全局变量
刚才说到repeatString.c做了一个动作: &ldquo;保证<code>php_repeatString.h</code>头文件内定义的全局变量线程安全&rdquo;,具体实现的方法只有一句:</p>

<pre><code class="language-c">/* If you declare any globals in php_repeatString.h uncomment this:
ZEND_DECLARE_MODULE_GLOBALS(repeatString)
*/
</code></pre>

<p>这里有句注释说,如果在<code>php_repeatString.h</code>定义了全局变量,取消这一句注释,看一下这个宏做了些什么:</p>

<pre><code class="language-c">// zend_API.h
#ifdef ZTS
// 这里
#define ZEND_DECLARE_MODULE_GLOBALS(module_name)							\
// 初始化一个模块-线程id
	ts_rsrc_id module_name##_globals_id;
#define ZEND_EXTERN_MODULE_GLOBALS(module_name)								\
	extern ts_rsrc_id module_name##_globals_id;
// 调用这个宏分配一个模块-线程id,并注册模块全局变量构造函数和析构函数
#define ZEND_INIT_MODULE_GLOBALS(module_name, globals_ctor, globals_dtor)	\
	ts_allocate_id(&amp;module_name##_globals_id, sizeof(zend_##module_name##_globals), (ts_allocate_ctor) globals_ctor, (ts_allocate_dtor) globals_dtor);
// 这个宏用于取全局变量的值,当多线程模式时,根据生成的模块-线程id获取全局变量的值
#define ZEND_MODULE_GLOBALS_ACCESSOR(module_name, v) ZEND_TSRMG(module_name##_globals_id, zend_##module_name##_globals *, v)
#define ZEND_MODULE_GLOBALS_BULK(module_name) TSRMG_BULK(module_name##_globals_id, zend_##module_name##_globals *)
#else
// 非多线程模式下,只简单的初始化一个全局变量结构体
#define ZEND_DECLARE_MODULE_GLOBALS(module_name)							\
	zend_##module_name##_globals module_name##_globals;
#define ZEND_EXTERN_MODULE_GLOBALS(module_name)								\
	extern zend_##module_name##_globals module_name##_globals;
// 非多线程模式下,只简单调用构造函数对结构体初始化
#define ZEND_INIT_MODULE_GLOBALS(module_name, globals_ctor, globals_dtor)	\
	globals_ctor(&amp;module_name##_globals);
	
// 非多线程模式下,访问全局变量只是简单读取结构体内的值
#define ZEND_MODULE_GLOBALS_ACCESSOR(module_name, v) (module_name##_globals.v)
#define ZEND_MODULE_GLOBALS_BULK(module_name) (&amp;module_name##_globals)
#endif
</code></pre>

<p>看了几个php源码自带的php扩展,多数都是在<code>MINIT</code>方法里调用<code>ZEND_INIT_MODULE_GLOBALS</code>方法初始化全集变量,而<code>ext_skel</code>框架却没有生成备注的<code>ZEND_INIT_MODULE_GLOBALS</code>代码,比较奇怪.
###总结
1. 一般写php扩展,目的可能是: 做php做不到的东西,或者想优化php性能
2. php提供一个框架让我们一键生成php扩展所需的源码文件
3. php扩展生效有两种方式: 1: 编译时加入 2: 配置文件php.ini运行时加载动态库</p>

<p>资料地址:</p>

<blockquote>
<p><a href="http://www.laruence.com/2009/04/28/719.html">用C/C++扩展你的PHP</a></p>
</blockquote>

<p>补充:
分享时出的问题,忘了原来是php提供的扩展生成工具的shell脚本有bug,具体可以看<a href="https://segmentfault.com/q/1010000004493105">这里</a></p>

            </div>
            
            <div class="post-comments">
                
            </div>
            
            <div class="push"></div>
        </div>
        <footer class="footer text-center">
<p>Copyright &copy; 2018 Hello, I&#39;m trainyao. -
<span class="credit">
	Powered by
	<a target="_blank" href="https://gohugo.io">Hugo</a>
	and
	<a target="_blank" href="https://github.com/LordMathis/hugo-theme-nix/">Nix</a> theme.
</span>
</p>
</footer>

    </body>
